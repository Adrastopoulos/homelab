---
- name: Bootstrap Proxmox VE hosts with helper scripts
  hosts: pve
  become: yes
  gather_facts: yes

  vars:
    helper_scripts_url: "https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/misc"

  tasks:
    - name: Ensure curl is installed
      apt:
        name: curl
        state: present
        update_cache: yes
      tags: ["prerequisites"]

    - name: Download and run Post PVE Install script
      shell: |
        bash -c "$(wget -qLO - {{ helper_scripts_url }}/post-pve-install.sh)"
      args:
        creates: /etc/apt/sources.list.d/pve-no-subscription.list
      register: post_install_result
      tags: ["post-install"]

    - name: Show Post PVE Install results
      debug:
        var: post_install_result.stdout_lines
      when: post_install_result.changed
      tags: ["post-install"]

    - name: Install Python3 and pip (required for Ansible modules)
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
        state: present
      tags: ["python"]

    - name: Install Proxmox Python library for Ansible modules
      pip:
        name:
          - proxmoxer
          - requests
        state: present
      tags: ["python"]

    - name: Ensure SSH key directory exists
      file:
        path: /root/.ssh
        state: directory
        mode: "0700"
        owner: root
        group: root
      tags: ["ssh"]

    - name: Display next steps
      debug:
        msg:
          - "Bootstrap completed"
          - "Run ongoing management: ansible-playbook playbooks/system/proxmox-hosts.yaml"
      tags: ["info"]
