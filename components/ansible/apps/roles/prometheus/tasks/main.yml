---
- name: Create Prometheus directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ prometheus_config_path }}"
    - "{{ prometheus_storage_path }}"

- name: Generate Prometheus configuration
  template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_path }}/prometheus.yml"
    mode: "0644"
  notify: restart prometheus

- name: Create Docker volume for Prometheus data
  community.docker.docker_volume:
    name: prometheus-data
    state: present

- name: Deploy Prometheus container
  community.docker.docker_container:
    name: prometheus
    image: "prom/prometheus:{{ prometheus_version }}"
    state: started
    restart_policy: unless-stopped
    pull: true

    ports:
      - "{{ prometheus_port }}:9090"

    volumes:
      - "{{ prometheus_config_path }}/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
      - "prometheus-data:/prometheus"

    command: |
      --config.file=/etc/prometheus/prometheus.yml
      --storage.tsdb.path=/prometheus
      --storage.tsdb.retention.time={{ prometheus_data_retention }}
      --web.console.libraries=/etc/prometheus/console_libraries
      --web.console.templates=/etc/prometheus/consoles
      --web.enable-lifecycle
      --web.enable-admin-api

    env:
      TZ: "{{ timezone | default('UTC') }}"

- name: Verify Prometheus is running
  docker_container_info:
    name: prometheus
  register: prometheus_info
  until: prometheus_info.container.State.Running
  retries: 5
  delay: 10
