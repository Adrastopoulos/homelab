server:
  log_level: {{ grafana_agent_log_level | default('info') }}

metrics:
  wal_directory: /tmp/grafana-agent/wal
  global:
    scrape_interval: {{ grafana_agent_scrape_interval | default('15s') }}
    external_labels:
      cluster: {{ grafana_agent_cluster | default('homelab') }}
      instance: {{ ansible_hostname }}

  configs:
    - name: integrations
      remote_write:
        - url: {{ grafana_agent_prometheus_url | default('http://prometheus:9090/api/v1/write') }}

      scrape_configs:
        # Node exporter metrics
        - job_name: 'node-exporter'
          static_configs:
            - targets: ['localhost:9100']
          relabel_configs:
            - source_labels: [__address__]
              target_label: instance
              replacement: {{ ansible_hostname }}

        # Docker metrics
        - job_name: 'docker'
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            - source_labels: [__meta_docker_container_name]
              target_label: container_name
            - source_labels: [__meta_docker_container_id]
              target_label: container_id

        # Application metrics (if available)
{% for app in grafana_agent_apps | default([]) %}
        - job_name: '{{ app.name }}'
          static_configs:
            - targets: ['{{ app.target | default('localhost:' + app.port) }}']
{% endfor %}

integrations:
  node_exporter:
    enabled: true
    instance: {{ ansible_hostname }}

logs:
  configs:
    - name: default
      clients:
        - url: {{ grafana_agent_loki_url | default('http://loki:3100/loki/api/v1/push') }}

      positions:
        filename: /tmp/positions.yaml

      scrape_configs:
        # System logs
        - job_name: syslog
          static_configs:
            - targets:
                - localhost
              labels:
                job: syslog
                host: {{ ansible_hostname }}
                __path__: /var/log/syslog

        # Docker container logs
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            - source_labels: [__meta_docker_container_name]
              target_label: container_name
            - source_labels: [__meta_docker_container_id]
              target_label: container_id
            - source_labels: [__meta_docker_container_log_stream]
              target_label: stream
            - source_labels: [__meta_docker_container_id]
              replacement: /var/lib/docker/containers/$1/$1-json.log
              target_label: __path__