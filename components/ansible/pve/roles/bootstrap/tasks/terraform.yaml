- name: Check if Terraform user exists
  shell: pveum user list | grep -qw 'terraform@pve'
  register: tf_user_exists
  failed_when: false
  changed_when: false
  run_once: true

- name: Create Terraform user
  shell: pveum user add terraform@pve
  when: tf_user_exists.rc != 0
  run_once: true

- name: Check if Terraform role exists
  shell: pveum role list | grep -qw 'Terraform'
  register: tf_role_exists
  failed_when: false
  changed_when: false
  run_once: true

- name: Create Terraform role
  shell: |
    pveum role add Terraform \
      -privs "Datastore.Allocate,Datastore.AllocateSpace,Datastore.AllocateTemplate,Datastore.Audit,Pool.Allocate,Sys.Audit,Sys.Console,Sys.Modify,VM.Allocate,VM.Audit,VM.Clone,VM.Config.CDROM,VM.Config.Cloudinit,VM.Config.CPU,VM.Config.Disk,VM.Config.HWType,VM.Config.Memory,VM.Config.Network,VM.Config.Options,VM.Migrate,VM.PowerMgmt,User.Modify"
  when: tf_role_exists.rc != 0
  run_once: true

- name: Check if Terraform role is assigned
  shell: pveum acl list / | grep -E "terraform@pve.*Terraform"
  register: tf_role_assigned
  failed_when: false
  changed_when: false
  run_once: true

- name: Assign Terraform role
  shell: pveum aclmod / -user terraform@pve -role Terraform
  when: tf_role_assigned.rc != 0
  run_once: true

- name: Check if Terraform API token exists
  shell: pveum user token list terraform@pve | grep -qw provider
  register: tf_token_exists
  failed_when: false
  changed_when: false
  run_once: true

- name: Create Terraform API token
  shell: pveum user token add terraform@pve provider --privsep=0 --output-format=json
  when: tf_token_exists.rc != 0
  register: tf_token_raw
  run_once: true

- name: Extract token value
  set_fact:
    tf_token_value: "{{ (tf_token_raw.stdout | from_json).value }}"
  when: tf_token_raw is defined and tf_token_raw.changed
  run_once: true

- name: Display Terraform token
  debug:
    msg:
      - "Token ID: terraform@pve!provider"
      - "Token Secret: {{ tf_token_value }}"
  when: tf_token_raw is defined and tf_token_raw.changed
